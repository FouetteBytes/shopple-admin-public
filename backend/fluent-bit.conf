# Fluent Bit Configuration for Shopple Admin Backend
# Place this file at: /etc/fluent-bit/fluent-bit.conf (Linux)
# or: /usr/local/etc/fluent-bit/fluent-bit.conf (macOS with Homebrew)

[SERVICE]
    # Flush interval in seconds
    Flush        5
    
    # Run in foreground (set to On for systemd)
    Daemon       Off
    
    # Log level for Fluent Bit itself
    Log_Level    info
    
    # HTTP server for monitoring
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    
    # Parsers configuration
    Parsers_File parsers.conf

# Input: Read JSON logs from Shopple Admin backend
[INPUT]
    Name              tail
    Path              /app/backend/logs/shopple_admin.json.log
    Parser            json
    Tag               shopple.backend
    Refresh_Interval  10
    Read_from_Head    true
    
    # Skip lines that are not valid JSON
    Skip_Empty_Lines  On

# Filter: Add additional metadata
[FILTER]
    Name    modify
    Match   shopple.*
    
    # Add application name
    Add     app shopple-admin
    
    # Add environment
    Add     environment development

# Output 1: Send to Grafana Loki (disabled for now)
# [OUTPUT]
#     Name   loki
#     Match  shopple.*
#     Host   localhost
#     Port   3100
#     Labels job=shopple-backend, app=shopple-admin
#     Retry_Limit 3

# Output 2: Send to Elasticsearch (optional)
# [OUTPUT]
#     Name  es
#     Match shopple.*
#     Host  localhost
#     Port  9200
#     Index shopple-backend
#     Type  _doc
#     Logstash_Format On
#     Logstash_Prefix shopple-backend
#     Time_Key timestamp

# Output 3: Write to file for debugging (optional)
# [OUTPUT]
#     Name  file
#     Match shopple.*
#     Path  /var/log/fluent-bit/
#     File  shopple-backend.log
#     Format json_lines

# Output: Send to Local OpenSearch
[OUTPUT]
    Name  es
    Match shopple.*
    Host  opensearch
    Port  9200
    Index shopple-logs
    Type  _doc
    Logstash_Format On
    Logstash_Prefix shopple-logs
    Time_Key timestamp
    Suppress_Type_Name On
    tls   Off
    Buffer_Size 2MB
    Retry_Limit 3

# Output 4: Send to standard output for testing
[OUTPUT]
    Name   stdout
    Match  shopple.*
    Format json_lines
