# ===========================================================================
# Ingress - Single entry point for external traffic
# ===========================================================================
#
# Purpose
# -------
# Use a single Ingress controller to route traffic by URL path or hostname
# instead of provisioning a LoadBalancer per service.

# Local development
# -----------------
# 1. Install NGINX Ingress Controller:
#    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
#
# 2. Wait for it to be ready:
#    kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=120s
#
# 3. Access via: http://localhost (Ingress Controller binds to port 80/443)
#
# Cloud deployment
# ----------------
# The Ingress controller automatically provisions a cloud LoadBalancer.
# Update the host field below with the desired domain (e.g., app.example.com).
#
# ===========================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: shopple-ingress
  annotations:
    # NGINX Ingress controller annotations.
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    # WebSocket support for SSE (Server-Sent Events).
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    # Rewrite /api/* to /* when forwarding to the backend.
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  ingressClassName: nginx
  rules:
  # ---------------------------------------------------------------------------
  # Local development (no hostname; matches any).
  # For cloud deployments, set the host to the target domain (e.g., app.example.com).
  # ---------------------------------------------------------------------------
  - http:
      paths:
      # Frontend auth routes → frontend (Next.js API routes).
      # Must come before /api to take precedence.
      - path: /api/auth
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      # Frontend admin session management routes → frontend (Next.js API routes).
      # Be specific to avoid catching backend /api/admin/users/online routes.
      - path: /api/admin/change-password
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      - path: /api/admin/change-password-v2
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      - path: /api/admin/force-password-reset
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      - path: /api/admin/emergency-reset
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      - path: /api/admin/manage-sessions
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      - path: /api/admin/avatar
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000
      
      # Backend API routes → backend (Flask).
      # This catches all /api/*, including /api/admin/users/*.
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 5001
      
      # Health check endpoint.
      - path: /health
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 5001
      
      # OpenSearch Dashboards.
      - path: /dashboards
        pathType: Prefix
        backend:
          service:
            name: opensearch-dashboards
            port:
              number: 5601
      
      # Catch-all route → frontend (must be last).
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 3000

---
# ===========================================================================
# Alternative: host-based routing for cloud with custom domains
# ===========================================================================
# Uncomment and configure when using separate domains per service.
#
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: shopple-ingress-cloud
#   annotations:
#     nginx.ingress.kubernetes.io/proxy-body-size: "50m"
#     cert-manager.io/cluster-issuer: "letsencrypt-prod"  # For HTTPS.
# spec:
#   ingressClassName: nginx
#   tls:
#   - hosts:
#     - app.example.com
#     - api.example.com
#     - dashboards.example.com
#     secretName: shopple-tls
#   rules:
#   - host: app.example.com
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: frontend
#             port:
#               number: 3000
#   - host: api.example.com
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: backend
#             port:
#               number: 5001
#   - host: dashboards.example.com
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: opensearch-dashboards
#             port:
#               number: 5601
